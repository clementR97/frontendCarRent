<div class="admin-dashboard">
  <div class="dashboard-header">
    <h1>üöó Gestion des Voitures</h1>
    <button class="btn-add" (click)="openAddForm()">
      ‚ûï Ajouter une voiture
    </button>
  </div>

  <!-- Liste des voitures -->
  <div class="voitures-grid" *ngIf="!showForm">
    <div class="voiture-card" *ngFor="let voiture of voitures">
      <div class="voiture-info">
        <h3>{{ voiture.marque }} {{ voiture.modele }}</h3>
        <p><strong>Ann√©e:</strong> {{ voiture.annee }}</p>
        <p><strong>Prix/jour:</strong> {{ voiture.prixParJour }}‚Ç¨</p>
        <p><strong>Statut:</strong> 
          <span [class]="voiture.disponible ? 'status-available' : 'status-unavailable'">
            {{ voiture.disponible ? 'Disponible' : 'Indisponible' }}
          </span>
        </p>
        
        <!-- Aper√ßu des images -->
        <div class="voiture-images" *ngIf="voiture.images && voiture.images.length > 0">
          <img 
            *ngFor="let img of voiture.images" 
            [src]="img.url" 
            [alt]="img.alt" 
            class="voiture-thumb">
        </div>
      </div>
      <div class="voiture-actions">
        <button class="btn-edit" (click)="openEditForm(voiture)">
          ‚úèÔ∏è Modifier
        </button>
        <button class="btn-delete" (click)="deleteVoiture(voiture._id!)">
          üóëÔ∏è Supprimer
        </button>
      </div>
    </div>
  </div>

  <!-- Formulaire d'ajout/modification -->
  <div class="form-container" *ngIf="showForm && selectedVoiture">
    <div class="form-card">
      <h2>{{ isEditing ? 'Modifier la voiture' : 'Ajouter une voiture' }}</h2>
      
      <form (ngSubmit)="saveVoiture()">
        <div class="form-group">
          <label for="marque">Marque *</label>
          <input 
            id="marque" 
            type="text" 
            [(ngModel)]="selectedVoiture.marque" 
            name="marque" 
            required>
        </div>

        <div class="form-group">
          <label for="modele">Mod√®le *</label>
          <input 
            id="modele" 
            type="text" 
            [(ngModel)]="selectedVoiture.modele" 
            name="modele" 
            required>
        </div>

        <div class="form-group">
          <label for="annee">Ann√©e *</label>
          <input 
            id="annee" 
            type="text" 
            [(ngModel)]="selectedVoiture.annee" 
            name="annee" 
            required>
        </div>

        <div class="form-group">
          <label for="prixParJour">Prix par jour (‚Ç¨) *</label>
          <input 
            id="prixParJour" 
            type="number" 
            [(ngModel)]="selectedVoiture.prixParJour" 
            name="prixParJour" 
            min="0" 
            step="0.01" 
            required>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="selectedVoiture.disponible" 
              name="disponible">
            Disponible
          </label>
        </div>
       <div class="form-group">
        <h3>Caract√©ristiques:*</h3>
        <!-- nombres de sieges -->
        <div class="form-group">
          <label>nombre de Siege :</label>
          <select [(ngModel)]="selectedSieges" name="caracteristiques">
            <option *ngFor="let personne of personnes" [value]="personne.value">
              {{ personne.name }}
            </option>
          </select>
        </div>
        <!-- type de motorisation -->
        <div class="form-group">
          <label>type de motorisation :</label>
          <select [(ngModel)]="selectedMotorisation" name="caracteristiques">
            <option *ngFor="let motor of typeMotorisation" >
              {{ motor.name }}
            </option>
          </select>
        </div>
        <!-- type transmission -->
        <div class="form-group">
          <label>type de transmission :</label>
          <select [(ngModel)]="selectedTransmission" name="caracteristiques">
            <option *ngFor="let transmission of boiteTransmission">
              {{ transmission.name }}
            </option>
          </select>
        </div>
       </div>
        <!-- Ajoutez aussi un champ description -->
          <div class="form-group">
            <label for="description">Description</label>
            <textarea 
              id="description" 
              [(ngModel)]="selectedVoiture.description" 
              name="description"
              rows="3"
              placeholder="Description de la voiture...">
            </textarea>
          </div>

        <!-- Dans la section IA pour les images -->
        <div class="form-group ai-section">
          <label>Images avec IA ü§ñ</label>
          
          <!-- Upload multiple d'images -->
          <input 
            type="file" 
            accept="image/*" 
            multiple
            (change)="onFilesSelected($event)"
            class="file-input">
          
          <!-- S√©lection du fond -->
          <div class="background-selector">
            <label>Fond souhait√© :</label>
            <select [(ngModel)]="selectedBackground" name="background">
              <option *ngFor="let bg of availableBackgrounds" [value]="bg.value">
                {{ bg.name }}
              </option>
            </select>
          </div>

          <!-- Bouton de traitement IA pour toutes les images -->
          <button 
            type="button" 
            class="btn-ai-process" 
            (click)="processAllImagesWithAI()"
            [disabled]="!selectedFiles || selectedFiles.length === 0">
            ü§ñ Traiter {{ selectedFiles?.length || 0 }} images avec IA
          </button>

          <!-- Liste des images s√©lectionn√©es -->
          <div class="selected-files" *ngIf="selectedFiles && selectedFiles.length > 0">
            <h5>Images s√©lectionn√©es ({{ selectedFiles.length }}/6) :</h5>
            <div class="files-list">
              <div class="file-item" *ngFor="let file of selectedFiles; let i = index">
                <span>{{ file.name }}</span>
                <button type="button" class="btn-remove-file" (click)="removeFile(i)">
                  ‚ùå
                </button>
              </div>
            </div>
          </div>

          <!-- R√©sultats du traitement IA -->
          <div class="ai-results" *ngIf="processedImages.length > 0">
            <h4>Images trait√©es avec IA :</h4>
            
            <div class="processed-images-grid">
              <div class="processed-image-item" *ngFor="let imageData of processedImages; let i = index">
                <h5>Image {{ i + 1 }}</h5>
                
                <!-- S√©lection d'image principale -->
                <div class="image-selection">
                  <div class="image-options">
                    <div class="image-option" (click)="selectImageForIndex(i, 'original')" [class.selected]="imageData.selectedUrl === imageData.variants.original">
                      <img [src]="imageData.variants.original" alt="Original">
                      <span>Original</span>
                    </div>
                    
                    <div class="image-option" (click)="selectImageForIndex(i, 'backgroundRemoved')" [class.selected]="imageData.selectedUrl === imageData.variants.backgroundRemoved">
                      <img [src]="imageData.variants.backgroundRemoved" alt="Sans fond">
                      <span>Sans fond</span>
                    </div>
                    
                    <div class="image-option" (click)="selectImageForIndex(i, 'withGrayBackground')" [class.selected]="imageData.selectedUrl === imageData.variants.withGrayBackground">
                      <img [src]="imageData.variants.withGrayBackground" alt="Fond gris">
                      <span>Fond gris</span>
                    </div>
                  </div>
                </div>

                <!-- Variantes d'arri√®re-plan -->
                <div class="background-variants" *ngIf="imageData.backgroundVariants && imageData.backgroundVariants.length > 0">
                  <h6>Fonds personnalis√©s :</h6>
                  <div class="variants-grid">
                    <div 
                      class="variant-item" 
                      *ngFor="let variant of imageData.backgroundVariants"
                      (click)="selectBackgroundVariantForIndex(i, variant)"
                      [class.selected]="imageData.selectedUrl === variant.url">
                      <img [src]="variant.url" [alt]="variant.color">
                      <span>{{ variant.name }}</span>
                    </div>
                  </div>
                </div>

                <!-- Bouton pour ajouter cette image -->
                <button 
                  type="button" 
                  class="btn-add-single-image" 
                  (click)="addSingleImageToVoiture(i)"
                  [disabled]="!imageData.selectedUrl">
                  ‚ûï Ajouter cette image
                </button>
              </div>
            </div>

            <!-- Bouton pour ajouter toutes les images -->
            <button 
              type="button" 
              class="btn-add-all-images" 
              (click)="addAllImagesToVoiture()"
              [disabled]="processedImages.length === 0">
              ‚ûï Ajouter toutes les images ({{ processedImages.length }})
            </button>
          </div>

          <!-- Images d√©j√† ajout√©es -->
          <div class="added-images" *ngIf="selectedVoiture.images && selectedVoiture.images.length > 0">
            <h5>Images ajout√©es ({{ selectedVoiture.images.length }}/6) :</h5>
            <div class="added-images-grid">
              <div class="added-image-item" *ngFor="let img of selectedVoiture.images; let i = index">
                <img [src]="img.url" [alt]="img.alt">
                <button 
                  type="button" 
                  class="btn-remove-added" 
                  (click)="removeImageFromVoiture(i)">
                  ‚ùå
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-save">
            {{ isEditing ? 'üíæ Modifier' : '‚ûï Ajouter' }}
          </button>
          <button type="button" class="btn-cancel" (click)="closeForm()">
            ‚ùå Annuler
          </button>
        </div>
      </form>
    </div>
  </div>
</div>